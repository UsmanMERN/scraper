<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Web Scraper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
</head>

<body>
    <div class="container-fluid mt-4">
        <h1 class="text-center mb-4">Advanced Web Scraper</h1>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Add this after the flash messages in index.html -->
        {% if debug_info %}
        <div class="card mb-4">
            <div class="card-body">
                <h4>Debug Information</h4>
                <p>General Records: {{ debug_info.general_count }}</p>
                <p>Product Records: {{ debug_info.product_count }}</p>
            </div>
        </div>
        {% endif %}
        <!-- Scrape Form -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="POST" class="mb-0">
                    <div class="input-group">
                        <input type="url" class="form-control" name="url" placeholder="Enter URL to scrape" required>
                        <select class="form-select" name="scrape_type">
                            <option value="general">General Scraping</option>
                            <option value="products">Product Scraping</option>
                        </select>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Scrape
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Table for General Data -->
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="card-title mb-4">General Scraped Data</h2>
                <div class="table-responsive">
                    <table id="resultsTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>URL</th>
                                <th>Emails</th>
                                <th>Phone Numbers</th>
                                <th>Social Links</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data %}
                            <tr>
                                <td>{{ row.url }}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" data-bs-toggle="modal"
                                        data-bs-target="#dataModal" data-bs-content="{{ row.emails|tojson }}">
                                        View ({{ row.emails|length }})
                                    </button>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" data-bs-toggle="modal"
                                        data-bs-target="#dataModal" data-bs-content="{{ row.phone_numbers|tojson }}">
                                        View ({{ row.phone_numbers|length }})
                                    </button>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" data-bs-toggle="modal"
                                        data-bs-target="#dataModal" data-bs-content="{{ row.social_links|tojson }}">
                                        View ({{ row.social_links|length }})
                                    </button>
                                </td>
                                <td>{{ row.last_updated }}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary view-full-data"
                                        data-row='{{ row|tojson|safe }}'>
                                        Full Data
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Results Table for Product Data -->
        <div class="card">
            <div class="card-body">
                <h2 class="card-title mb-4">Product Scraped Data</h2>
                <div class="table-responsive">
                    <table id="productTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>URL</th>
                                <th>Title</th>
                                <th>Price</th>
                                <th>Rating</th>
                                <th>Availability</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in product_data %}
                            <tr>
                                <td>{{ row.url }}</td>
                                <td>{{ row.title }}</td>
                                <td>{{ row.price }} {{ row.currency }}</td>
                                <td>{{ row.rating }}</td>
                                <td>{{ row.availability }}</td>
                                <td>{{ row.last_updated }}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary view-full-data"
                                        data-row='{{ row|tojson|safe }}'>
                                        Full Data
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for displaying data -->
    <div class="modal fade" id="dataModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Data View</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre class="modal-content-pre"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <script>
        // Initialize DataTables
        $(document).ready(function () {
            $('#resultsTable').DataTable({
                order: [[4, 'desc']],
                pageLength: 25
            });

            $('#productTable').DataTable({
                order: [[5, 'desc']],
                pageLength: 25
            });

            // Handle full data view button clicks
            $('.view-full-data').on('click', function () {
                const data = $(this).data('row');
                const modal = new bootstrap.Modal(document.getElementById('dataModal'));
                const modalPre = document.querySelector('.modal-content-pre');
                modalPre.textContent = JSON.stringify(data, null, 2);
                modal.show();
            });
        });

        // Modal handling for other buttons
        const dataModal = document.getElementById('dataModal');
        dataModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            if (button && button.hasAttribute('data-bs-content')) {
                const content = button.getAttribute('data-bs-content');
                const modalPre = dataModal.querySelector('.modal-content-pre');
                modalPre.textContent = JSON.stringify(JSON.parse(content), null, 2);
            }
        });
    </script>
</body>

</html>